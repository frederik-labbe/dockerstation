<!DOCTYPE html>
<head>
<title>Docker Station</title>
<style type="text/css">
#image_list li { font-weight:bold; list-style-type:square; font-size:24px; margin-bottom:10px; }
#image_list li li { font-family:Courier New; font-weight:normal; list-style-type:circle; text-indent:25px; font-size:18px; margin:0; }
#image_list li li a { color:#000000; text-decoration:none; }
#image_list li li a:hover { text-decoration:underline; }
</style>
</head>
<body>
<div class="box">
    <h2>Local images:</h2>
    <div id="image_list"></div>
</div>

<script>
var exampleSocket = new WebSocket("ws://localhost:8085", "echo-protocol");

exampleSocket.onopen = function (event) {
    console.log("Connected to Docker!");
};

exampleSocket.onmessage = function (event) {
    var message = JSON.parse(event.data);

    switch (message.type) {
        case 'imagesUpdate':
            if (_e('image_list').innerHTML == '') {
                var listElement = _e('image_list');
            
                listElement.innerHTML = '';
                var dockerImages = message.value;
                
                dockerImages.forEach(function(image) {
                    var imageLi = _c('li');
                    imageLi.appendChild(
                        document.createTextNode(image.REPOSITORY)
                    );
                    listElement.appendChild(imageLi);
                });
            }
            break;

        case 'psUpdate':
            var interv = window.setInterval(function() {
                if (_e('image_list').innerHTML != '') {
                    window.clearInterval(interv);
                    
                    var imagesContainersId = {};
                    var imagesContainersFriendlyName = {};
                    var dockerContainers = message.value;
                    
                    dockerContainers.forEach(function(container) {
                        var id = container['CONTAINER ID'];
                        if (typeof imagesContainersId[container.IMAGE] == "undefined") {
                            imagesContainersId[container.IMAGE] = [id];
                        } else {
                            imagesContainersId[container.IMAGE].push(id);
                        }
                        
                        var friendlyName = id + ' => ' + container['NAMES'];
                        if (typeof imagesContainersFriendlyName[container.IMAGE] == "undefined") {
                            imagesContainersFriendlyName[container.IMAGE] = [friendlyName];
                        } else {
                            imagesContainersFriendlyName[container.IMAGE].push(friendlyName);
                        }
                    });
                    
                    Array.from(_e('image_list').getElementsByTagName('li')).forEach(function(imageElement) {
                        var containerList = _c('div');
                        containerList.class = 'container-list';
                        
                        var friendlyNames = typeof imagesContainersFriendlyName[imageElement.innerHTML] == "undefined" ? [] : imagesContainersFriendlyName[imageElement.innerHTML];
                        friendlyNames.forEach(function(containerName, containerIndex) {
                            var containerLi = _c('li');
                            var containerLink = _c('a');
                            containerLink.href = '/console?dockerId=' + imagesContainersId[imageElement.innerHTML][containerIndex];
                            containerLink.target = '_blank';
                            containerLink.innerHTML = containerName;
                            containerLi.appendChild(containerLink);
                            containerList.appendChild(containerLi);
                        });
                        imageElement.appendChild(containerList);
                    });
                }
            }, 1);
            break;
    }
}

exampleSocket.onerror = function (event) {
  console.log("Error while trying to connect to Docker. Did you start connection/server.js ?");
};

function _e(id) {
    return document.getElementById(id);
}

function _c(tagName) {
    return document.createElement(tagName);
}
</script>
</body>
</html>
